
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  Bug, Sparkles, CheckCircle2, Scan, 
  Code2, Terminal, ArrowRight, Layers, 
  ShieldCheck, Database, GitMerge, Cpu,
  AlertTriangle, Microscope, PlayCircle, FileCode
} from 'lucide-react';

// --- DATA FOR SIMULATION ---
const VULN_SCENARIOS = [
  {
    id: 'sqli',
    title: 'SQL Injection (SQLi)',
    severity: 'Critical',
    location: 'login.php : Line 42',
    description: 'User input is concatenated directly into a database query without sanitization, allowing attackers to manipulate the SQL statement.',
    vulnerableCode: `
$username = $_POST['username'];
// VULNERABLE: Direct concatenation
$query = "SELECT * FROM users WHERE user = '" . $username . "'";
$result = $db->query($query);
    `,
    fixedCode: `
$username = $_POST['username'];
// SECURE: Prepared Statement
$stmt = $db->prepare("SELECT * FROM users WHERE user = ?");
$stmt->bind_param("s", $username);
$stmt->execute();
$result = $stmt->get_result();
    `,
    aiAnalysis: "The AI detected a classic SQLi pattern. Input from `$_POST` reaches the sink `$db->query` without sanitization. Recommended fix involves parameterizing the query using `prepare` and `bind_param` to separate code from data."
  },
  {
    id: 'xss',
    title: 'Reflected XSS',
    severity: 'High',
    location: 'search.js : Line 15',
    description: 'Search terms are reflected back to the user in the DOM without escaping, enabling script execution.',
    vulnerableCode: `
const query = new URLSearchParams(window.location.search).get('q');
// VULNERABLE: innerHTML allows script injection
document.getElementById('results').innerHTML = "Results for: " + query;
    `,
    fixedCode: `
const query = new URLSearchParams(window.location.search).get('q');
// SECURE: textContent treats input as plain text
document.getElementById('results').textContent = "Results for: " + query;
    `,
    aiAnalysis: "The use of `innerHTML` with unsanitized URL parameters creates a Cross-Site Scripting (XSS) vulnerability. The AI recommends switching to `textContent` or using a sanitization library like DOMPurify."
  },
  {
    id: 'iac',
    title: 'S3 Bucket Public Access',
    severity: 'Medium',
    location: 'terraform/storage.tf',
    description: 'Infrastructure as Code configuration explicitly allows public read access to sensitive storage.',
    vulnerableCode: `
resource "aws_s3_bucket" "data" {
  bucket = "customer-data"
  // VULNERABLE: Public read access
  acl    = "public-read"
}
    `,
    fixedCode: `
resource "aws_s3_bucket" "data" {
  bucket = "customer-data"
  // SECURE: Private access
  acl    = "private"
}

resource "aws_s3_bucket_public_access_block" "block" {
  bucket = aws_s3_bucket.data.id
  block_public_acls = true
}
    `,
    aiAnalysis: "The Terraform plan exposes an S3 bucket publicly. AI Policy Engine flagged this against 'No Public Storage' compliance rule. Recommendation is to enforce private ACL and attach a Public Access Block resource."
  }
];

const IMPLEMENTATION_STEPS = [
  { title: "Data Integration", desc: "Connect vulnerability scanners (Tenable, Qualys) and Code Repos (GitHub) to the AI Data Lake.", icon: Database },
  { title: "Context Training", desc: "Train the model on your specific tech stack and business criticality to reduce false positives.", icon: BrainCircuit },
  { title: "Automated Triage", desc: "Enable AI to auto-close low-risk findings and tag critical ones for developer review.", icon: Microscope },
  { title: "Generative Remediation", desc: "Deploy GenAI agents to open Pull Requests with suggested code fixes automatically.", icon: GitMerge }
];

// --- SUB-COMPONENTS ---

const CodeBlock = ({ code, label, color }: { code: string, label: string, color: string }) => (
  <div className={`rounded-xl overflow-hidden border ${color === 'red' ? 'border-rose-900/50' : 'border-emerald-900/50'} bg-slate-950 font-mono text-xs relative group`}>
    <div className={`px-4 py-2 ${color === 'red' ? 'bg-rose-900/20 text-rose-400' : 'bg-emerald-900/20 text-emerald-400'} flex justify-between items-center border-b ${color === 'red' ? 'border-rose-900/30' : 'border-emerald-900/30'}`}>
      <span className="font-bold uppercase tracking-wider flex items-center gap-2">
        {color === 'red' ? <AlertTriangle className="w-3 h-3"/> : <CheckCircle2 className="w-3 h-3"/>}
        {label}
      </span>
      <span className="text-[10px] opacity-50">Snippet</span>
    </div>
    <div className="p-4 overflow-x-auto">
      <pre className={`${color === 'red' ? 'text-rose-100' : 'text-emerald-100'}`}>
        {code.trim()}
      </pre>
    </div>
  </div>
);

const RemediationEngine = () => {
  const [selectedScenario, setSelectedScenario] = useState(VULN_SCENARIOS[0]);
  const [isFixing, setIsFixing] = useState(false);
  const [showFix, setShowFix] = useState(false);

  const handleFix = () => {
    setIsFixing(true);
    setShowFix(false);
    setTimeout(() => {
      setIsFixing(false);
      setShowFix(true);
    }, 1500);
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
      {/* Sidebar List */}
      <div className="lg:col-span-4 space-y-4">
        <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 px-2">Detected Vulnerabilities</h3>
        {VULN_SCENARIOS.map((vuln) => (
          <button
            key={vuln.id}
            onClick={() => { setSelectedScenario(vuln); setShowFix(false); }}
            className={`w-full p-4 rounded-xl border text-left transition-all duration-300 group relative overflow-hidden ${
              selectedScenario.id === vuln.id 
                ? 'bg-slate-800 border-teal-500/50 shadow-lg shadow-teal-900/20' 
                : 'bg-slate-900/50 border-slate-800 hover:bg-slate-800 hover:border-slate-700'
            }`}
          >
            <div className="flex justify-between items-start mb-2 relative z-10">
              <span className="font-bold text-white">{vuln.title}</span>
              <span className={`text-[10px] px-2 py-0.5 rounded-full border font-bold uppercase ${
                vuln.severity === 'Critical' ? 'bg-rose-950 border-rose-900 text-rose-400' :
                vuln.severity === 'High' ? 'bg-orange-950 border-orange-900 text-orange-400' :
                'bg-yellow-950 border-yellow-900 text-yellow-400'
              }`}>{vuln.severity}</span>
            </div>
            <p className="text-xs text-slate-500 font-mono relative z-10">{vuln.location}</p>
            {selectedScenario.id === vuln.id && (
               <div className="absolute inset-0 bg-gradient-to-r from-teal-500/5 to-transparent" />
            )}
          </button>
        ))}
      </div>

      {/* Workspace */}
      <div className="lg:col-span-8 bg-slate-900 rounded-3xl border border-slate-800 overflow-hidden shadow-2xl flex flex-col h-full min-h-[600px]">
        {/* Toolbar */}
        <div className="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-950/50">
           <div className="flex items-center gap-3">
              <div className="p-2 bg-teal-500/10 rounded-lg border border-teal-500/20">
                 <Terminal className="w-5 h-5 text-teal-400" />
              </div>
              <div>
                 <h2 className="text-lg font-bold text-white">{selectedScenario.title}</h2>
                 <p className="text-xs text-slate-500">AI Confidence Score: 98%</p>
              </div>
           </div>
           <button 
             onClick={handleFix}
             disabled={isFixing || showFix}
             className="px-5 py-2 bg-teal-600 hover:bg-teal-500 disabled:bg-slate-800 disabled:text-slate-500 text-white rounded-lg text-sm font-bold flex items-center gap-2 transition-all shadow-lg shadow-teal-900/20"
           >
             {isFixing ? <Sparkles className="w-4 h-4 animate-spin" /> : <Sparkles className="w-4 h-4" />}
             {isFixing ? 'Generating Fix...' : showFix ? 'Fix Generated' : 'Generate AI Fix'}
           </button>
        </div>

        {/* Content */}
        <div className="p-8 flex-1 overflow-y-auto space-y-8">
           
           {/* Analysis */}
           <div className="space-y-3">
              <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                 <Microscope className="w-4 h-4" /> Root Cause Analysis
              </h4>
              <p className="text-slate-300 text-sm leading-relaxed bg-slate-800/30 p-4 rounded-xl border border-slate-800">
                 {selectedScenario.description}
              </p>
           </div>

           {/* Code Comparison */}
           <div className="grid grid-cols-1 gap-6">
              <CodeBlock code={selectedScenario.vulnerableCode} label="Vulnerable Code" color="red" />
              
              <AnimatePresence mode="wait">
                {showFix && (
                  <motion.div 
                    initial={{ opacity: 0, y: 20 }} 
                    animate={{ opacity: 1, y: 0 }}
                    className="space-y-4"
                  >
                     <div className="flex justify-center">
                        <ArrowRight className="w-6 h-6 text-slate-600 rotate-90" />
                     </div>
                     
                     <div className="bg-teal-900/10 border border-teal-500/20 p-4 rounded-xl flex gap-3 items-start">
                        <Sparkles className="w-5 h-5 text-teal-400 mt-0.5 flex-shrink-0" />
                        <div>
                           <h5 className="text-teal-300 font-bold text-sm mb-1">AI Remediation Logic</h5>
                           <p className="text-teal-200/70 text-xs leading-relaxed">{selectedScenario.aiAnalysis}</p>
                        </div>
                     </div>

                     <CodeBlock code={selectedScenario.fixedCode} label="Proposed Patch" color="green" />
                  </motion.div>
                )}
              </AnimatePresence>
           </div>
        </div>
      </div>
    </div>
  );
};

// --- MAIN VIEW ---

const AiVulnerabilityView: React.FC = () => {
  return (
    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="space-y-20 pb-20">
      
      {/* Hero Section */}
      <section className="relative py-12 overflow-hidden rounded-[2.5rem] bg-gradient-to-br from-slate-900 to-slate-950 border border-slate-800 shadow-2xl">
         <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-teal-600/10 rounded-full blur-[120px] -translate-y-1/2 translate-x-1/3" />
         <div className="absolute bottom-0 left-0 w-[400px] h-[400px] bg-purple-600/10 rounded-full blur-[100px] translate-y-1/3 -translate-x-1/3" />
         
         <div className="relative z-10 px-8 md:px-16">
            <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-teal-950/50 border border-teal-500/30 text-teal-300 text-xs font-bold uppercase tracking-widest mb-6 backdrop-blur-sm">
               <ShieldCheck className="w-3 h-3" /> Next-Gen SecOps
            </div>
            <h1 className="text-5xl md:text-6xl font-black text-white leading-tight mb-6">
               AI-Driven <br />
               <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-emerald-400">Vulnerability Management</span>
            </h1>
            <p className="text-lg text-slate-400 max-w-2xl leading-relaxed">
               Move beyond static scanning. Leverage Machine Learning to predict exploitability, 
               automate triage, and generate code-level fixes for your engineering team.
            </p>
         </div>
      </section>

      {/* The Problem vs Solution */}
      <section className="grid grid-cols-1 md:grid-cols-2 gap-8">
         <div className="bg-slate-900/30 border border-slate-800 p-8 rounded-3xl">
            <div className="w-12 h-12 bg-slate-800 rounded-2xl flex items-center justify-center mb-6 border border-slate-700">
               <Layers className="w-6 h-6 text-slate-400" />
            </div>
            <h3 className="text-xl font-bold text-slate-300 mb-4">Traditional Approach</h3>
            <ul className="space-y-4 text-slate-400 text-sm">
               <li className="flex gap-3 items-start">
                  <span className="text-rose-500 font-mono">✕</span>
                  <span>Flood of false positives leads to alert fatigue.</span>
               </li>
               <li className="flex gap-3 items-start">
                  <span className="text-rose-500 font-mono">✕</span>
                  <span>Prioritization based only on generic CVSS scores.</span>
               </li>
               <li className="flex gap-3 items-start">
                  <span className="text-rose-500 font-mono">✕</span>
                  <span>Manual patching takes weeks or months.</span>
               </li>
            </ul>
         </div>

         <div className="bg-gradient-to-br from-teal-950/30 to-slate-900/50 border border-teal-500/20 p-8 rounded-3xl relative overflow-hidden">
            <div className="absolute top-0 right-0 w-32 h-32 bg-teal-500/10 blur-3xl rounded-full" />
            <div className="w-12 h-12 bg-teal-500/10 rounded-2xl flex items-center justify-center mb-6 border border-teal-500/30">
               <Cpu className="w-6 h-6 text-teal-400" />
            </div>
            <h3 className="text-xl font-bold text-white mb-4">AI-Enhanced Approach</h3>
            <ul className="space-y-4 text-slate-300 text-sm">
               <li className="flex gap-3 items-start">
                  <CheckCircle2 className="w-4 h-4 text-teal-400 mt-0.5" />
                  <span>Context-aware filtering reduces noise by 90%.</span>
               </li>
               <li className="flex gap-3 items-start">
                  <CheckCircle2 className="w-4 h-4 text-teal-400 mt-0.5" />
                  <span>Risk scoring based on real-world exploitability.</span>
               </li>
               <li className="flex gap-3 items-start">
                  <CheckCircle2 className="w-4 h-4 text-teal-400 mt-0.5" />
                  <span>Automated PRs with secure code suggestions.</span>
               </li>
            </ul>
         </div>
      </section>

      {/* Interactive Engine */}
      <section>
         <div className="flex items-center gap-4 mb-10">
            <h2 className="text-3xl font-bold text-white">Remediation Simulation</h2>
            <div className="h-px bg-slate-800 flex-1" />
         </div>
         <RemediationEngine />
      </section>

      {/* Implementation Roadmap */}
      <section className="bg-slate-900 rounded-[3rem] border border-slate-800 p-10 md:p-16 relative overflow-hidden">
         <div className="absolute inset-0 bg-[linear-gradient(rgba(20,184,166,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(20,184,166,0.03)_1px,transparent_1px)] bg-[size:40px_40px]" />
         
         <div className="relative z-10">
            <h2 className="text-3xl font-bold text-white mb-12 text-center">Strategic Rollout Plan</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
               {IMPLEMENTATION_STEPS.map((step, i) => (
                  <div key={i} className="relative group">
                     <div className="bg-slate-950 border border-slate-800 p-8 rounded-3xl h-full hover:border-teal-500/30 transition-all hover:-translate-y-2 duration-300">
                        <div className="w-12 h-12 bg-slate-900 rounded-2xl flex items-center justify-center mb-6 border border-slate-800 group-hover:border-teal-500/30 group-hover:bg-teal-500/10 transition-colors">
                           <step.icon className="w-6 h-6 text-slate-400 group-hover:text-teal-400 transition-colors" />
                        </div>
                        <div className="text-5xl font-black text-slate-800 absolute top-4 right-6 opacity-50 group-hover:text-teal-900/50 transition-colors select-none">
                           0{i+1}
                        </div>
                        <h4 className="text-lg font-bold text-white mb-3">{step.title}</h4>
                        <p className="text-sm text-slate-400 leading-relaxed">
                           {step.desc}
                        </p>
                     </div>
                     {i < 3 && (
                        <div className="hidden md:block absolute top-1/2 -right-3 transform -translate-y-1/2 z-20 text-slate-700">
                           <ArrowRight className="w-6 h-6" />
                        </div>
                     )}
                  </div>
               ))}
            </div>
         </div>
      </section>

    </motion.div>
  );
};

// Helper Icons
function BrainCircuit(props: any) {
  return (
    <svg 
      {...props} 
      xmlns="http://www.w3.org/2000/svg" 
      width="24" height="24" viewBox="0 0 24 24" 
      fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
    >
      <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z" />
      <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z" />
      <path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4" />
      <path d="M17.599 6.5a3 3 0 0 0 .399-1.375" />
      <path d="M6.003 5.125A3 3 0 0 0 6.401 6.5" />
      <path d="M3.477 12.578a4 4 0 0 1-.317-.795" />
      <path d="M20.84 11.783a4 4 0 0 1-.317.795" />
      <path d="M9 21v-5" />
      <path d="M15 21v-5" />
    </svg>
  )
}

export default AiVulnerabilityView;
